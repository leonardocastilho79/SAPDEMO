# Refer√™ncia de Queries SAP HANA - Monitoramento e Performance

Este documento cont√©m queries √∫teis para monitoramento e an√°lise de performance do SAP HANA.

## üìä Views de Sistema Principais

### Mem√≥ria e Recursos

#### M_HOST_RESOURCE_UTILIZATION
Informa√ß√µes sobre utiliza√ß√£o de recursos do host HANA.

```sql
SELECT
  HOST,
  INSTANCE_TOTAL_MEMORY_ALLOCATED_SIZE / 1024 / 1024 / 1024 AS TOTAL_MEMORY_GB,
  INSTANCE_TOTAL_MEMORY_USED_SIZE / 1024 / 1024 / 1024 AS USED_MEMORY_GB,
  INSTANCE_CODE_SIZE / 1024 / 1024 / 1024 AS CODE_SIZE_GB,
  INSTANCE_SHARED_MEMORY_ALLOCATED_SIZE / 1024 / 1024 / 1024 AS SHARED_MEMORY_GB,
  CPU_BUSY_PCT,
  CPU_IDLE_PCT
FROM M_HOST_RESOURCE_UTILIZATION;
```

#### M_SERVICE_MEMORY
Uso de mem√≥ria por servi√ßo HANA.

```sql
SELECT
  SERVICE_NAME,
  HOST,
  PORT,
  USED_MEMORY_SIZE / 1024 / 1024 / 1024 AS USED_MEMORY_GB,
  PHYSICAL_MEMORY_SIZE / 1024 / 1024 / 1024 AS PHYSICAL_MEMORY_GB,
  HEAP_MEMORY_USED_SIZE / 1024 / 1024 / 1024 AS HEAP_MEMORY_GB,
  SHARED_MEMORY_USED_SIZE / 1024 / 1024 / 1024 AS SHARED_MEMORY_GB
FROM M_SERVICE_MEMORY
ORDER BY USED_MEMORY_SIZE DESC;
```

#### M_MEMORY_OBJECTS
Objetos de mem√≥ria individuais.

```sql
SELECT TOP 20
  CATEGORY,
  OBJECT_NAME,
  MEMORY_SIZE_IN_TOTAL / 1024 / 1024 AS MEMORY_MB,
  COUNT
FROM M_MEMORY_OBJECTS
ORDER BY MEMORY_SIZE_IN_TOTAL DESC;
```

### Performance de Queries

#### M_SQL_PLAN_CACHE
Cache de planos de execu√ß√£o SQL.

```sql
SELECT TOP 50
  STATEMENT_HASH,
  EXECUTION_COUNT,
  TOTAL_EXECUTION_TIME / 1000 AS TOTAL_TIME_MS,
  AVG_EXECUTION_TIME / 1000 AS AVG_TIME_MS,
  TOTAL_CURSOR_DURATION / 1000 AS TOTAL_CURSOR_MS,
  TOTAL_RESULT_RECORD_COUNT,
  SUBSTR(STATEMENT_STRING, 1, 200) AS STATEMENT
FROM M_SQL_PLAN_CACHE
WHERE EXECUTION_COUNT > 0
ORDER BY TOTAL_EXECUTION_TIME DESC;
```

#### M_EXPENSIVE_STATEMENTS
Statements caros em execu√ß√£o.

```sql
SELECT
  STATEMENT_HASH,
  CONNECTION_ID,
  USER_NAME,
  START_TIME,
  DURATION_MICROSEC / 1000 AS DURATION_MS,
  MEMORY_SIZE / 1024 / 1024 AS MEMORY_MB,
  CPU_TIME / 1000 AS CPU_TIME_MS,
  RECORDS,
  SUBSTR(STATEMENT_STRING, 1, 500) AS STATEMENT
FROM M_EXPENSIVE_STATEMENTS
ORDER BY DURATION_MICROSEC DESC;
```

#### M_ACTIVE_STATEMENTS
Statements atualmente em execu√ß√£o.

```sql
SELECT
  STATEMENT_HASH,
  CONNECTION_ID,
  TRANSACTION_ID,
  USER_NAME,
  APPLICATION_USER_NAME,
  APPLICATION_NAME,
  START_TIME,
  CURRENT_TIMESTAMP,
  SECONDS_BETWEEN(START_TIME, CURRENT_TIMESTAMP) AS RUNNING_SECONDS,
  SUBSTR(STATEMENT_STRING, 1, 300) AS STATEMENT
FROM M_ACTIVE_STATEMENTS
ORDER BY START_TIME;
```

### Conex√µes e Sess√µes

#### M_CONNECTIONS
Conex√µes ativas ao HANA.

```sql
SELECT
  CONNECTION_ID,
  HOST,
  PORT,
  CONNECTION_STATUS,
  USER_NAME,
  CLIENT_HOST,
  CLIENT_IP,
  CLIENT_PID,
  CLIENT_APPLICATION,
  START_TIME,
  IDLE_TIME,
  TRANSACTION_ID
FROM M_CONNECTIONS
WHERE CONNECTION_STATUS IN ('RUNNING', 'IDLE')
ORDER BY CONNECTION_STATUS, START_TIME;
```

#### M_SESSION_CONTEXT
Contexto de sess√µes ativas.

```sql
SELECT
  HOST,
  PORT,
  CONNECTION_ID,
  KEY,
  VALUE
FROM M_SESSION_CONTEXT
WHERE CONNECTION_ID IN (
  SELECT CONNECTION_ID
  FROM M_CONNECTIONS
  WHERE CONNECTION_STATUS = 'RUNNING'
);
```

#### M_SERVICE_THREADS
Threads de servi√ßos HANA.

```sql
SELECT
  SERVICE_NAME,
  HOST,
  PORT,
  THREAD_TYPE,
  THREAD_STATE,
  THREAD_DETAIL,
  DURATION,
  CONNECTION_ID,
  STATEMENT_HASH
FROM M_SERVICE_THREADS
WHERE THREAD_STATE = 'Running'
ORDER BY DURATION DESC;
```

### Bloqueios e Transa√ß√µes

#### M_BLOCKED_TRANSACTIONS
Transa√ß√µes bloqueadas.

```sql
SELECT
  HOST,
  PORT,
  BLOCKED_TRANSACTION_ID,
  BLOCKING_TRANSACTION_ID,
  BLOCKED_TIME,
  LOCK_TYPE,
  LOCK_MODE,
  LOCK_OWNER_TRANSACTION_ID,
  LOCK_OWNER_UPDATE_TRANSACTION_ID
FROM M_BLOCKED_TRANSACTIONS
ORDER BY BLOCKED_TIME DESC;
```

#### M_TRANSACTIONS
Transa√ß√µes ativas.

```sql
SELECT
  HOST,
  PORT,
  TRANSACTION_ID,
  TRANSACTION_STATUS,
  START_TIME,
  MIN_MVCC_SNAPSHOT_TIMESTAMP,
  CONNECTION_ID,
  USER_NAME,
  APPLICATION_NAME
FROM M_TRANSACTIONS
WHERE TRANSACTION_STATUS = 'ACTIVE'
ORDER BY START_TIME;
```

### Cargas e Hist√≥rico

#### M_LOAD_HISTORY_SERVICE
Hist√≥rico de carga do servi√ßo.

```sql
SELECT
  HOST,
  PORT,
  TIMESTAMP,
  SERVICE_NAME,
  CPU,
  MEMORY_USED / 1024 / 1024 / 1024 AS MEMORY_USED_GB,
  MEMORY_ALLOCATION_LIMIT / 1024 / 1024 / 1024 AS MEMORY_LIMIT_GB
FROM M_LOAD_HISTORY_SERVICE
WHERE TIMESTAMP >= ADD_DAYS(CURRENT_TIMESTAMP, -1)
ORDER BY TIMESTAMP DESC;
```

#### M_LOAD_HISTORY_HOST
Hist√≥rico de carga do host.

```sql
SELECT
  HOST,
  TIMESTAMP,
  MEMORY_RESIDENT / 1024 / 1024 / 1024 AS RESIDENT_GB,
  MEMORY_TOTAL_RESIDENT / 1024 / 1024 / 1024 AS TOTAL_RESIDENT_GB,
  MEMORY_SIZE / 1024 / 1024 / 1024 AS MEMORY_SIZE_GB,
  INSTANCE_TOTAL_MEMORY_USED_SIZE / 1024 / 1024 / 1024 AS INSTANCE_USED_GB,
  CPU_PCT
FROM M_LOAD_HISTORY_HOST
WHERE TIMESTAMP >= ADD_DAYS(CURRENT_TIMESTAMP, -1)
ORDER BY TIMESTAMP DESC;
```

### Volumes e Disco

#### M_DISK_USAGE
Uso de disco.

```sql
SELECT
  HOST,
  USAGE_TYPE,
  DISK_SIZE / 1024 / 1024 / 1024 AS DISK_SIZE_GB,
  USED_SIZE / 1024 / 1024 / 1024 AS USED_SIZE_GB,
  (DISK_SIZE - USED_SIZE) / 1024 / 1024 / 1024 AS FREE_SIZE_GB,
  CAST(USED_SIZE * 100.0 / DISK_SIZE AS DECIMAL(5,2)) AS USED_PCT
FROM M_DISK_USAGE
ORDER BY USED_PCT DESC;
```

#### M_VOLUME_FILES
Arquivos de volume HANA.

```sql
SELECT
  HOST,
  PORT,
  VOLUME_ID,
  FILE_NAME,
  FILE_TYPE,
  FILE_SIZE / 1024 / 1024 / 1024 AS FILE_SIZE_GB,
  USED_SIZE / 1024 / 1024 / 1024 AS USED_SIZE_GB
FROM M_VOLUME_FILES
ORDER BY FILE_SIZE DESC;
```

### Tabelas e √çndices

#### M_TABLE_STATISTICS
Estat√≠sticas de tabelas.

```sql
SELECT TOP 50
  SCHEMA_NAME,
  TABLE_NAME,
  RECORD_COUNT,
  MEMORY_SIZE_IN_TOTAL / 1024 / 1024 AS MEMORY_SIZE_MB,
  DISK_SIZE / 1024 / 1024 AS DISK_SIZE_MB,
  LAST_COMPRESSED_RECORD_COUNT,
  LAST_OPTIMIZE_TIME
FROM M_TABLE_STATISTICS
ORDER BY MEMORY_SIZE_IN_TOTAL DESC;
```

#### M_CS_TABLES
Tabelas column store.

```sql
SELECT
  SCHEMA_NAME,
  TABLE_NAME,
  MEMORY_SIZE_IN_TOTAL / 1024 / 1024 AS MEMORY_MB,
  DISK_SIZE / 1024 / 1024 AS DISK_MB,
  RAW_RECORD_COUNT_IN_MAIN,
  RAW_RECORD_COUNT_IN_DELTA,
  READ_COUNT,
  WRITE_COUNT,
  MERGE_COUNT
FROM M_CS_TABLES
WHERE SCHEMA_NAME NOT IN ('SYS', '_SYS_STATISTICS')
ORDER BY MEMORY_SIZE_IN_TOTAL DESC;
```

### Backup e Recovery

#### M_BACKUP_CATALOG
Cat√°logo de backups.

```sql
SELECT
  ENTRY_ID,
  SYS_START_TIME,
  SYS_END_TIME,
  BACKUP_ID,
  ENTRY_TYPE_NAME,
  STATE_NAME,
  MESSAGE,
  BACKUP_SIZE / 1024 / 1024 / 1024 AS BACKUP_SIZE_GB,
  SECONDS_BETWEEN(SYS_START_TIME, SYS_END_TIME) AS DURATION_SECONDS
FROM M_BACKUP_CATALOG
ORDER BY SYS_START_TIME DESC;
```

## üîç Queries de Diagn√≥stico Comuns

### Top 10 Queries Mais Lentas

```sql
SELECT TOP 10
  STATEMENT_HASH,
  EXECUTION_COUNT,
  TOTAL_EXECUTION_TIME / 1000000 AS TOTAL_TIME_SEC,
  AVG_EXECUTION_TIME / 1000 AS AVG_TIME_MS,
  TOTAL_RESULT_RECORD_COUNT,
  SUBSTR(STATEMENT_STRING, 1, 500) AS STATEMENT
FROM M_SQL_PLAN_CACHE
WHERE EXECUTION_COUNT > 0
ORDER BY AVG_EXECUTION_TIME DESC;
```

### Mem√≥ria Dispon√≠vel vs Usada

```sql
SELECT
  HOST,
  ROUND(INSTANCE_TOTAL_MEMORY_ALLOCATED_SIZE / 1024 / 1024 / 1024, 2) AS ALLOCATED_GB,
  ROUND(INSTANCE_TOTAL_MEMORY_USED_SIZE / 1024 / 1024 / 1024, 2) AS USED_GB,
  ROUND((INSTANCE_TOTAL_MEMORY_ALLOCATED_SIZE - INSTANCE_TOTAL_MEMORY_USED_SIZE) / 1024 / 1024 / 1024, 2) AS FREE_GB,
  ROUND(INSTANCE_TOTAL_MEMORY_USED_SIZE * 100.0 / INSTANCE_TOTAL_MEMORY_ALLOCATED_SIZE, 2) AS USED_PCT
FROM M_HOST_RESOURCE_UTILIZATION;
```

### Sess√µes Longas em Execu√ß√£o

```sql
SELECT
  CONNECTION_ID,
  USER_NAME,
  APPLICATION_NAME,
  START_TIME,
  SECONDS_BETWEEN(START_TIME, CURRENT_TIMESTAMP) AS DURATION_SECONDS,
  STATEMENT_HASH,
  SUBSTR(STATEMENT_STRING, 1, 300) AS STATEMENT
FROM M_ACTIVE_STATEMENTS
WHERE SECONDS_BETWEEN(START_TIME, CURRENT_TIMESTAMP) > 300
ORDER BY DURATION_SECONDS DESC;
```

### Tabelas que Necessitam de Delta Merge

```sql
SELECT
  SCHEMA_NAME,
  TABLE_NAME,
  RAW_RECORD_COUNT_IN_DELTA,
  RAW_RECORD_COUNT_IN_MAIN,
  CAST(RAW_RECORD_COUNT_IN_DELTA * 100.0 / NULLIF(RAW_RECORD_COUNT_IN_MAIN, 0) AS DECIMAL(10,2)) AS DELTA_PCT,
  LAST_MERGE_TIME
FROM M_CS_TABLES
WHERE RAW_RECORD_COUNT_IN_DELTA > 0
  AND RAW_RECORD_COUNT_IN_MAIN > 0
  AND RAW_RECORD_COUNT_IN_DELTA * 100.0 / RAW_RECORD_COUNT_IN_MAIN > 10
ORDER BY DELTA_PCT DESC;
```

### Usu√°rios Conectados Atualmente

```sql
SELECT
  USER_NAME,
  COUNT(*) AS CONNECTION_COUNT,
  MIN(START_TIME) AS FIRST_CONNECTION,
  MAX(START_TIME) AS LAST_CONNECTION,
  STRING_AGG(DISTINCT CLIENT_APPLICATION, ', ') AS APPLICATIONS
FROM M_CONNECTIONS
WHERE CONNECTION_STATUS IN ('RUNNING', 'IDLE')
GROUP BY USER_NAME
ORDER BY CONNECTION_COUNT DESC;
```

## üéØ Queries de Performance Tuning

### Cache Hit Ratio

```sql
SELECT
  HOST,
  PORT,
  SERVICE_NAME,
  TOTAL_HIT_COUNT,
  TOTAL_MISS_COUNT,
  TOTAL_HIT_COUNT + TOTAL_MISS_COUNT AS TOTAL_ACCESSES,
  CAST(TOTAL_HIT_COUNT * 100.0 / NULLIF(TOTAL_HIT_COUNT + TOTAL_MISS_COUNT, 0) AS DECIMAL(10,2)) AS HIT_RATIO_PCT
FROM M_CACHES
ORDER BY HIT_RATIO_PCT;
```

### I/O Statistics

```sql
SELECT
  HOST,
  PORT,
  VOLUME_ID,
  TYPE,
  TOTAL_READS,
  TOTAL_WRITES,
  TOTAL_READ_SIZE / 1024 / 1024 / 1024 AS TOTAL_READ_GB,
  TOTAL_WRITE_SIZE / 1024 / 1024 / 1024 AS TOTAL_WRITE_GB,
  TOTAL_READ_TIME / 1000000 AS TOTAL_READ_TIME_SEC,
  TOTAL_WRITE_TIME / 1000000 AS TOTAL_WRITE_TIME_SEC
FROM M_VOLUME_IO_TOTAL_STATISTICS
ORDER BY TOTAL_READ_SIZE + TOTAL_WRITE_SIZE DESC;
```

## üìù Notas Importantes

1. **Permiss√µes**: Muitas views de sistema requerem privil√©gios especiais para leitura
2. **Performance**: Queries em views de sistema podem impactar performance
3. **Hist√≥rico**: Algumas views mant√™m dados hist√≥ricos limitados
4. **Vers√£o**: Algumas views podem variar entre vers√µes do HANA

## üîó Refer√™ncias

- SAP HANA SQL and System Views Reference
- SAP HANA Administration Guide
- SAP HANA Performance Guide

---

**√öltima atualiza√ß√£o:** Outubro 2025
